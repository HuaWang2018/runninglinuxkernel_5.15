《ARM 64 体系结构编程与实践》一书成书于2020年，但其创作时是基于20.04，现在ubuntu 20.04已经停止更新支持了，本作者购置了新的PC，也是基于24.04版本，于是如何基于24.04搭建开发环境，就成为一个问题。另外，《实践》一书并没有具体的文档是如何创建根文件系统的，需要是能哪些kernel driver来支持qemu，以本作者看来，也是一种实践吧。 作者分三篇文章来描述：

- 如何在ubuntu 24.04上编译qemu，尽量使能全部的feature。
- 在ubutnu 24.04上创建ubuntu 20.04根文件系统，以便5.15内核能够挂载。
- 配置桥接网络，让qemu虚拟机能够访问到主机，主机也能访问到虚拟机（虚拟机和主机在同一网段）。

文本是关于桥接网络的配置部分。 

# 桥接网络的原理

**桥接的概念** 

- 网络桥接是在数据链路层（OSI第二层）工作的，它能够将多个网络接口链接在一起，使它们看起来仿佛在同一个物理网络中。
- 其作用是使所有加入的接口处于同一广播域内，可以直接进行通信，就像连接在同一交换机上一样。
- 在家用网络来说，就是可以和你的PC一样，可以从你家的路由器上通过DHCP服务器获取地址。

**TAP接口**

- TAP （Terminal Access Point）接口是一种虚拟网络设备，允许用户空间的程序直接与内核网络栈进行以太网级别的通信。因此它工作在数据链路层，能够收发完整的以太网帧。
- 虚拟机QEMU通过TAP让虚拟机的网络流量进入主机的网络栈，并通过主机的网络接口发送到外部网络；同时外部发送给虚拟机的网络数据也通过主机接收。

**将TAP 加入桥接的原因**

- 桥接的目的是通过将TAP接口和物理网络接口（比如eth0）加入同一个桥接，使虚拟机和主机的物理网络处于同一网络环境中。
- 虚拟机可以和主机一样，从DHCP服务器获取IP地址，与外部网络直接进行通信。

**数据流动过程**

1. 虚拟机发送数据包
   - 虚拟机内的应用程序发送网络数据，经过虚拟机的虚拟网卡，进入TAP接口。
2. TAP接口转发数据
   - TAP接口将数据包传递给桥接接口。
3. 桥接接口处理数据
   - 桥接接口根据以太网帧的MAC地址，觉定将数据包发送到物理接口eth0，从而达到外部网络。

**同样的过程适用于从外部网络到虚拟机的数据包。**

# 软件对桥接的支持

主机和虚拟机都需要有对桥接的支持：

- 虚拟机需要在内核中支持虚拟网卡，比如E1000网卡（CONFIG_E1000=y）。
- QEMU也支持该种虚拟网卡，比如E1000（qemu-system-aarch64 -M virt -device --help）。
- 主机内核已经支持TAP （grep CONFIG_TUN /boot/config-$(uname -r))。
- 主机NetworkManager服务已经启用。
- bridge-utils帮助创建桥接口和TAP接口



# 网络桥接配置过程



## 1. 安装 `bridge-utils` 工具

```bash
sudo apt-get install bridge-utils
```

**解释：**
- **`bridge-utils`** 是一组用于配置桥接网络的实用工具，包括 `brctl` 命令。安装此工具可以帮助您查看和管理网络桥接接口。

---

## 2. 查看当前的 NetworkManager 连接

```bash
nmcli connection show
```

**解释：**
- **`nmcli connection show`** 列出了所有由 **NetworkManager** 管理的网络连接。这有助于您了解当前系统中已存在的网络配置，尤其是您计划删除或修改的连接。

---

## 3. 删除现有的 `netplan-eno3` 连接 (作者本机网卡是en03)

```bash
sudo nmcli connection delete netplan-eno3
```

**解释：**
- **`netplan-eno3`** 是由 **Netplan** 管理的 `eno3` 以太网接口的连接配置。为了将 `eno3` 接口添加到桥接 `br0` 中，首先需要删除独立管理的连接，以避免配置冲突。

---

## 4. 应用 Netplan 配置

```bash
sudo netplan apply
```

**解释：**
- **Netplan** 是 Ubuntu 的默认网络配置工具。运行 **`netplan apply`** 会应用当前的 Netplan 配置，确保系统识别到 **NetworkManager** 不再单独管理 `eno3` 接口。
- **注意** 一旦删除了netplan-eno3，主机ubuntu 24.04左面右上角将不再显示网络，主机的网络也停用了，直到激活桥接接口。

---

## 5. 创建桥接接口 `br0`

```bash
sudo nmcli connection add type bridge autoconnect yes ifname br0 con-name br0
```

**解释：**
- **创建桥接接口 `br0`**：
  - **`type bridge`**：指定连接类型为桥接。
  - **`autoconnect yes`**：设置为开机自动连接。
  - **`ifname br0`**：指定接口名称为 `br0`。
  - **`con-name br0`**：连接名称为 `br0`。

---

## 6. 将物理接口 `eno3` 添加为桥接的从属接口

```bash
sudo nmcli connection add type ethernet slave-type bridge autoconnect yes ifname eno3 master br0 con-name br0-slave-eno3
```

**解释：**
- **将 `eno3` 接口添加到桥接 `br0`**：
  - **`type ethernet`**：连接类型为以太网。
  - **`slave-type bridge`**：指定为桥接的从属接口。
  - **`ifname eno3`**：物理接口名称。
  - **`master br0`**：指定主接口为 `br0`。
  - **`con-name br0-slave-eno3`**：连接名称为 `br0-slave-eno3`。

---

## 7. 配置桥接接口 `br0` 使用 DHCP 获取 IP 地址

```bash
sudo nmcli connection modify br0 ipv4.method auto ipv6.method ignore
```

**解释：**
- **配置 `br0` 的 IP 设置**：
  - **`ipv4.method auto`**：使用 DHCP 自动获取 IPv4 地址。
  - **`ipv6.method ignore`**：忽略 IPv6 配置（如果需要 IPv6，可以根据需求调整）。

---

## 8. 激活桥接接口 `br0`

```bash
sudo nmcli connection up br0
```

**解释：**
- **激活 `br0` 连接**，使桥接接口开始工作并获取 IP 地址。

---

## 9. 激活桥接从属接口 `br0-slave-eno3`

```bash
sudo nmcli connection up br0-slave-eno3
```

**解释：**
- **激活 `br0-slave-eno3` 连接**，将 `eno3` 接口正式加入到桥接 `br0` 中。

---

## 10. 手动管理 `tap0` 接口并将其添加到桥接 `br0`

由于 **NetworkManager** 默认不管理 **`tun` 类型接口**（如 `tap0`），需要手动创建和配置 `tap0`，然后将其添加到桥接 `br0` 中。

### 10.1 创建 TAP 接口 `tap0`

```bash
sudo ip tuntap add dev tap0 mode tap user $(whoami)
sudo ip link set tap0 up
```

**解释：**
- **创建 `tap0` 接口**：
  - **`ip tuntap add dev tap0 mode tap user $(whoami)`**：创建一个 TAP 接口 `tap0`，并将其所有权赋予当前用户。
  - **`ip link set tap0 up`**：启用 `tap0` 接口，使其处于活动状态。tap0将一直显示DOWN直到虚拟机启动。

### 10.2 将 `tap0` 添加到桥接 `br0`

```bash
sudo brctl addif br0 tap0
brctl show br0
```

**解释：**

- **使用 `brctl` 工具将 `tap0` 添加到 `br0`**：
  
  - **`brctl addif br0 tap0`**：将 `tap0` 接口加入到桥接 `br0` 中。
  
  - **`brctl show br0`**：查看 `br0` 的桥接成员，确认 `tap0` 已成功加入。
  
    ```bash
    brctl show br0
    bridge name	bridge id		STP enabled	  interfaces
    br0		8000.7a49a89b6621	yes		      eno3
    							              tap0
    ```

---

## 11. 重新启动 NetworkManager

```bash
sudo systemctl restart NetworkManager
```

**解释：**

- **重启 NetworkManager**，确保所有网络配置更改生效，并刷新网络状态。

---

## **附加提示**

### **1. 验证桥接配置**

查看设备状态和桥接成员，确保配置正确。

```bash
nmcli device status
brctl show br0
ip addr show br0
```

### **2. 创建启动脚本（可选）**

为了在系统启动时自动创建并添加 `tap0` 到桥接，可以创建一个 `systemd` 服务。

**步骤：**

1. **创建脚本 `/usr/local/bin/setup-tap0.sh`**

   ```bash
   sudo nano /usr/local/bin/setup-tap0.sh
   ```

   **内容：**

   ```bash
   #!/bin/bash

   # 创建 tap0 接口
   ip tuntap add dev tap0 mode tap user $(whoami)
   
   # 启用 tap0 接口
   ip link set tap0 up
   
   # 将 tap0 添加到桥接 br0
   brctl addif br0 tap0
   ```

2. **赋予执行权限**

   ```bash
   sudo chmod +x /usr/local/bin/setup-tap0.sh
   ```

3. **创建 `systemd` 服务文件 `/etc/systemd/system/setup-tap0.service`**

   ```bash
   sudo nano /etc/systemd/system/setup-tap0.service
   ```

   **内容：**

   ```ini
   [Unit]
   Description=Setup tap0 and add to br0 bridge
   After=network.target

   [Service]
   Type=oneshot
   ExecStart=/usr/local/bin/setup-tap0.sh
   RemainAfterExit=yes

   [Install]
   WantedBy=multi-user.target
   ```

4. **启用并启动服务**

   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable setup-tap0.service
   sudo systemctl start setup-tap0.service
   ```

5. **验证服务状态**

   ```bash
   sudo systemctl status setup-tap0.service
   ```

### **3. 启动 QEMU 虚拟机并使用桥接网络**

确保桥接配置正确后，使用以下命令启动 QEMU 虚拟机，并通过桥接接口 (`tap0`) 连接网络。

```bash
qemu-system-aarch64 -M virt -cpu cortex-a72 -m 4096 \
  -kernel kernel/linux-5.15/arch/arm64/boot/Image \
  -append "root=/dev/vda rw console=ttyAMA0" \
  -drive file=root.img,format=raw,if=virtio \
  -netdev tap,id=net0,ifname=tap0,script=no,downscript=no \
  -device virtio-net-pci,netdev=net0 \
  -nographic
```

**参数解释：**

- **`-M`**：machine type。
- **`-m 4096`**：为虚拟机分配 4GB 内存。
- **`-cpu cortex-a72`**：使用ARM cortex-a72 CPU。
- **-append**: 内核启动参数，告知内核根文件系统挂载在/dev/vda上，可以读写，启动tty。
- **`-drive file`**：指定虚拟机根文件系统磁盘映像。
- **`-netdev tap,id=net0,ifname=tap0,script=no,downscript=no`**：
  - **`tap0`**：使用之前创建的 TAP 接口。
  - **`script=no,downscript=no`**：不使用默认的网络脚本，避免自动创建 TAP 接口。
- **`-device e1000,netdev=net0`**：在虚拟机中使用 e1000 网卡，并连接到 `net0`。
- **`-boot d` 和 `-cdrom /path/to/installer.iso`**：可选参数，用于从光盘启动（如安装操作系统）。

---

## **总结**

通过上述步骤，您已经成功使用 Markdown 语法编写了网络桥接配置文档，并在 Typora 中实现了实时预览。以下是关键点的回顾：
